#!/bin/env bash
# Wrapper script for setting random wallpapers on an interval using swww.
# This script will randomly go through the files of a directory, setting it
# up as the wallpaper at regular intervals
#
# NOTE: this script is in bash (not posix shell), because the RANDOM variable
# we use is not defined in posix

if [[ $# -lt 1 ]] || [[ ! -d $1 ]]; then
    echo "Usage:
	$0 <dir containing images>"
    exit 1
fi

# Start daemon if it is not already running
pgrep swww-daemon || coproc swww-daemon > /dev/null 2>&1

# Edit below to control the images transition
SWWW_TRANSITION_FPS=120
SWWW_TRANSITION_STEP=2
SWWW_TRANSITION_DURATION=1
SWWW_RESIZE="crop"

# This controls (in seconds) when to switch to the next image
INTERVAL=1800

wallpapers=("$1"/*)
while true; do
    # If the array is empty, refill it
    if [ ${#wallpapers[@]} -eq 0 ]; then
        wallpapers=("$1"/*)
    fi

    # Select random image
    index=$((RANDOM % ${#wallpapers[@]}))
    img="${wallpapers[$index]}"

    echo "Setting wallpaper: ${img}"
    swww img "$img" --transition-type outer --transition-pos 1.0,0.0 --transition-fps "$SWWW_TRANSITION_FPS" --transition-step "$SWWW_TRANSITION_STEP" --transition-duration "$SWWW_TRANSITION_DURATION" --resize "$SWWW_RESIZE"

    # Remove image from the array - so it can't be selected again until others have been cycled through
    unset "wallpapers[$index]"

    sleep "$INTERVAL"
done
